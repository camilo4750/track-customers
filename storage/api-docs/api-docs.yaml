openapi: 3.0.0
info:
  title: Track Clients API
  version: 1.0.0
  description: |
    API para la gestión de usuarios, clientes y permisos del sistema Track Clients.
    Autenticación JWT (cookie `jwt_token` o header `Authorization: Bearer <token>`).
    Todas las respuestas exitosas siguen el formato `{ success, message, data? }`.

servers:
  - url: http://localhost:8000
    description: Servidor de desarrollo

tags:
  - name: Auth
    description: Autenticación JWT (login, logout)
  - name: Users
    description: Gestión de usuarios
  - name: Clients
    description: Gestión de clientes
  - name: Permissions
    description: Permisos por usuario (Spatie)
  - name: Products
    description: Gestión de productos
  - name: Seeders
    description: Seeders de datos de prueba (solo desarrollo, rol admin)

security:
  - bearerAuth: []

paths:
  /api/auth/login:
    post:
      summary: Iniciar sesión
      description: "Devuelve un token JWT y los datos del usuario. El token puede enviarse en cookie jwt_token o en header Authorization: Bearer <token>."
      operationId: login
      tags:
        - Auth
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Credenciales inválidas o usuario inactivo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /api/auth/logout:
    post:
      summary: Cerrar sesión
      description: Invalida el token JWT. Requiere autenticación.
      operationId: logout
      tags:
        - Auth
      responses:
        '200':
          description: Sesión cerrada correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutResponse'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/users:
    get:
      summary: Listar usuarios
      description: Lista usuarios con filtros opcionales por rol y estado. Requiere JWT.
      operationId: listUsers
      tags:
        - Users
      parameters:
        - name: role
          in: query
          description: Filtrar por rol
          schema:
            type: string
            enum: [user, admin]
        - name: status
          in: query
          description: Filtrar por estado
          schema:
            type: string
            enum: [active, inactive]
      responses:
        '200':
          description: Lista de usuarios
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseUserList'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Crear usuario
      description: Crea un nuevo usuario. Requiere JWT y rol admin.
      operationId: createUser
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '200':
          description: Usuario creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /api/users/{id}:
    put:
      summary: Actualizar usuario
      description: Actualiza un usuario existente. Requiere JWT y rol admin.
      operationId: updateUser
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Usuario actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: No autenticado
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

    delete:
      summary: Eliminar usuario
      description: Elimina un usuario por ID. Requiere JWT y rol admin.
      operationId: deleteUser
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Usuario eliminado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: No autenticado
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/clients:
    get:
      summary: Listar clientes
      description: Lista clientes con filtros opcionales por estado. Requiere JWT.
      operationId: listClients
      tags:
        - Clients
      parameters:
        - name: status
          in: query
          description: Filtrar por estado
          schema:
            type: string
            enum: [active, inactive]
        - name: search
          in: query
          description: Búsqueda por texto (disponible para filtrado)
          schema:
            type: string
      responses:
        '200':
          description: Lista de clientes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseClientList'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Crear cliente
      description: Crea un nuevo cliente. Requiere JWT.
      operationId: createClient
      tags:
        - Clients
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateClientRequest'
      responses:
        '200':
          description: Cliente creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientSuccessResponse'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /api/clients/{id}:
    put:
      summary: Actualizar cliente
      description: Actualiza un cliente existente. Requiere JWT.
      operationId: updateClient
      tags:
        - Clients
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateClientRequest'
      responses:
        '200':
          description: Cliente actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientSuccessResponse'
        '401':
          description: No autenticado
        '404':
          description: Cliente no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

    delete:
      summary: Eliminar cliente
      description: Elimina un cliente por ID. Requiere JWT y rol admin.
      operationId: deleteClient
      tags:
        - Clients
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Cliente eliminado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientSuccessResponse'
        '401':
          description: No autenticado
        '403':
          description: Sin permisos (requiere rol admin)
        '404':
          description: Cliente no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/products:
    get:
      summary: Listar productos
      description: Lista productos con filtro opcional por categoría. Requiere JWT.
      operationId: listProducts
      tags:
        - Products
      parameters:
        - name: category
          in: query
          description: Filtrar por categoría
          schema:
            type: string
            maxLength: 100
      responses:
        '200':
          description: Lista de productos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseProductList'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Crear producto
      description: Crea un nuevo producto. Requiere JWT.
      operationId: createProduct
      tags:
        - Products
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProductRequest'
      responses:
        '200':
          description: Producto creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /api/products/{id}:
    put:
      summary: Actualizar producto
      description: Actualiza un producto existente. Requiere JWT.
      operationId: updateProduct
      tags:
        - Products
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProductRequest'
      responses:
        '200':
          description: Producto actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: No autenticado
        '404':
          description: Producto no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

    delete:
      summary: Eliminar producto
      description: Elimina un producto por ID. Requiere JWT y rol admin.
      operationId: deleteProduct
      tags:
        - Products
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Producto eliminado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: No autenticado
        '403':
          description: Sin permisos (requiere rol admin)
        '404':
          description: Producto no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/users/{id}/permissions:
    get:
      summary: Listar permisos del usuario
      description: Devuelve permisos agrupados por módulo y los IDs asignados al usuario. Requiere JWT.
      operationId: listUserPermissions
      tags:
        - Permissions
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Permisos listados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseUserPermissions'
        '401':
          description: No autenticado
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/users/{id}/permissions-sync:
    put:
      summary: Sincronizar permisos del usuario
      description: Reemplaza los permisos directos del usuario por la lista indicada. Requiere JWT y rol admin.
      operationId: syncUserPermissions
      tags:
        - Permissions
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncPermissionsRequest'
      responses:
        '200':
          description: Permisos sincronizados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: No autenticado
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

  /api/seeders:
    get:
      summary: Listar seeders disponibles
      description: |
        Devuelve la lista de seeders configurados por módulo (key, module, description, defaultCount).
        Requiere JWT y rol admin. Útil para la UI de datos de prueba.
      operationId: listSeeders
      tags:
        - Seeders
      responses:
        '200':
          description: Lista de seeders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseSeederList'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Sin permisos (requiere rol admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/seeders/run:
    post:
      summary: Ejecutar un seeder
      description: |
        Ejecuta el seeder indicado creando la cantidad de registros especificada.
        Requiere JWT y rol admin. Solo permitido en entorno de desarrollo (APP_ENV distinto de production).
        Si se omite count se usa el defaultCount del seeder.
      operationId: runSeeder
      tags:
        - Seeders
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunSeederRequest'
      responses:
        '200':
          description: Seeder ejecutado correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunSeederResponse'
        '401':
          description: No autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Sin permisos (rol admin) o entorno producción (seeders solo en desarrollo)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Seeder no encontrado (key inválido)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Error de validación (key o count inválidos)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT (también aceptado en cookie `jwt_token`)

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Juan Pérez
        email:
          type: string
          format: email
          example: juan@example.com
        role:
          type: string
          enum: [user, admin]
          example: user
        status:
          type: string
          enum: [active, inactive]
          example: active
        email_verified_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: admin@example.com
        password:
          type: string
          format: password
          example: password

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: ''
        token:
          type: string
          description: JWT access token
        expires_in:
          type: integer
          description: TTL del token en minutos
        user:
          $ref: '#/components/schemas/User'

    LogoutResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Sesión cerrada correctamente

    ApiResponseUserList:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Usuarios listados correctamente
        data:
          type: array
          items:
            $ref: '#/components/schemas/User'

    Client:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Empresa ABC
        email:
          type: string
          format: email
          example: cliente@empresa.com
        phone:
          type: string
          example: +34 600 123 456
        status:
          type: string
          enum: [active, inactive]
          example: active
        tags:
          type: array
          items:
            type: string
          example: [vip, corporativo]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ApiResponseClientList:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Clientes listados correctamente
        data:
          type: array
          items:
            $ref: '#/components/schemas/Client'

    CreateClientRequest:
      type: object
      required:
        - name
        - email
        - phone
        - status
        - tags
      properties:
        name:
          type: string
          maxLength: 255
          example: Empresa ABC
        email:
          type: string
          format: email
          maxLength: 255
          example: cliente@empresa.com
        phone:
          type: string
          maxLength: 50
          example: +34 600 123 456
        status:
          type: string
          enum: [active, inactive]
          example: active
        tags:
          type: array
          items:
            type: string
            maxLength: 50
          example: [vip, corporativo]

    UpdateClientRequest:
      type: object
      required:
        - name
        - email
        - phone
        - status
        - tags
      properties:
        name:
          type: string
          maxLength: 255
          example: Empresa ABC
        email:
          type: string
          format: email
          maxLength: 255
          example: cliente@empresa.com
        phone:
          type: string
          maxLength: 50
          example: +34 600 123 456
        status:
          type: string
          enum: [active, inactive]
          example: active
        tags:
          type: array
          items:
            type: string
            maxLength: 50
          example: [vip, corporativo]

    Product:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Producto ejemplo
        sku:
          type: string
          example: SKU-001
        price:
          type: number
          format: double
          example: 19.99
        category:
          type: string
          nullable: true
          example: Electrónica
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ApiResponseProductList:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Productos listados correctamente
        data:
          type: array
          items:
            $ref: '#/components/schemas/Product'

    CreateProductRequest:
      type: object
      required:
        - name
        - sku
        - price
      properties:
        name:
          type: string
          maxLength: 255
          example: Producto ejemplo
        sku:
          type: string
          maxLength: 100
          example: SKU-001
        price:
          type: number
          minimum: 0
          example: 19.99
        category:
          type: string
          maxLength: 100
          nullable: true
          example: Electrónica

    UpdateProductRequest:
      type: object
      required:
        - name
        - sku
        - price
      properties:
        name:
          type: string
          maxLength: 255
          example: Producto ejemplo
        sku:
          type: string
          maxLength: 100
          example: SKU-001
        price:
          type: number
          minimum: 0
          example: 19.99
        category:
          type: string
          maxLength: 100
          nullable: true
          example: Electrónica

    ClientSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Cliente 1 creado correctamente

    ApiResponseUserPermissions:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Permisos listados correctamente
        data:
          type: object
          properties:
            userId:
              type: integer
              example: 1
            userName:
              type: string
              example: Juan Pérez
            permissionsByModule:
              type: object
              additionalProperties:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                    action:
                      type: string
            userPermissionIds:
              type: array
              items:
                type: integer
              example: [1, 2, 3]

    SyncPermissionsRequest:
      type: object
      required:
        - permission_ids
      properties:
        permission_ids:
          type: array
          items:
            type: integer
          description: IDs de permisos (Spatie) a asignar al usuario
          example: [1, 2, 5]

    SeederItem:
      type: object
      description: Definición de un seeder disponible en la UI
      properties:
        key:
          type: string
          description: Identificador único del seeder (ej. clients, products)
          example: clients
        module:
          type: string
          description: Etiqueta del módulo de negocio para agrupar en la UI
          example: Clientes
        description:
          type: string
          description: Objetivo o descripción del seeder
          example: Genera clientes de prueba con nombre, email, teléfono, estado y tags.
        defaultCount:
          type: integer
          description: Cantidad por defecto de registros a crear
          example: 100

    ApiResponseSeederList:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Seeders listados correctamente
        data:
          type: array
          items:
            $ref: '#/components/schemas/SeederItem'

    RunSeederRequest:
      type: object
      required:
        - key
      properties:
        key:
          type: string
          description: Identificador del seeder (debe existir en la lista de seeders)
          example: clients
        count:
          type: integer
          minimum: 1
          maximum: 10000
          description: Cantidad de registros a crear. Si se omite se usa defaultCount del seeder.
          example: 100

    RunSeederResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Se crearon 100 registros correctamente.
        data:
          type: object
          properties:
            created:
              type: integer
              description: Número de registros creados
              example: 100

    CreateUserRequest:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
          maxLength: 255
          example: Juan Pérez
        email:
          type: string
          format: email
          maxLength: 255
          example: juan@example.com
        password:
          type: string
          format: password
          minLength: 8
          example: password123
        password_confirmation:
          type: string
          format: password
          example: password123
        role:
          type: string
          enum: [user, admin]
          default: user
        status:
          type: string
          enum: [active, inactive]
          default: active

    UpdateUserRequest:
      type: object
      required:
        - name
        - email
        - role
        - status
      properties:
        name:
          type: string
          maxLength: 255
          example: Juan Pérez
        email:
          type: string
          format: email
          maxLength: 255
          example: juan@example.com
        password:
          type: string
          format: password
          minLength: 8
          description: Opcional; si se envía, se actualiza la contraseña
        role:
          type: string
          enum: [user, admin]
          example: user
        status:
          type: string
          enum: [active, inactive]
          example: active

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Usuario 1 Creado correctamente

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: Usuario no encontrado
        code:
          type: integer
          example: 404
        errors:
          type: object
          additionalProperties:
            type: string

    ValidationErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        code:
          type: integer
          example: 422
        message:
          type: string
          example: Error al validar los datos
        errors:
          type: object
          additionalProperties:
            type: string
